---
export interface MapMarker {
	name: string;
	coordinates: [number, number];
	description?: string;
	type?: 'start' | 'poi' | 'end';
}

export interface MapPolyline {
	coordinates: [number, number][];
	color?: string;
	weight?: number;
	opacity?: number;
	dashArray?: string;
	popup?: string;
}

export interface MapCircle {
	center: [number, number];
	radius?: number; // in meters
	color?: string;
	fillColor?: string;
	fillOpacity?: number;
	popup?: string;
}

export interface MapPolygon {
	coordinates: [number, number][];
	color?: string;
	fillColor?: string;
	fillOpacity?: number;
	popup?: string;
}

export interface Props {
	height?: string;
	center?: [number, number];
	zoom?: number;
	gpxUrl?: string;
	markers?: MapMarker[];
	showDirections?: boolean;
	polylines?: MapPolyline[];
	circles?: MapCircle[];
	polygons?: MapPolygon[];
}

const { 
	height = "500px", 
	center = [42.9864, 13.2700], // Center on trail area
	zoom = 2,
	gpxUrl,
	markers = [],
	showDirections = false,
	polylines = [],
	circles = [],
	polygons = []
} = Astro.props;

const mapId = `map-${Math.random().toString(36).substring(7)}`;
---

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

<div id={mapId} class="rounded-lg shadow-lg" style={`height: ${height}`}></div>

<script define:vars={{ mapId, center, zoom, gpxUrl, markers, showDirections, polylines, circles, polygons }}>
  // Load Leaflet dynamically
  const script = document.createElement('script');
  script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
  script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
  script.crossOrigin = '';
  
  script.onload = function() {
    const map = L.map(mapId).setView(center, zoom);
    
    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 18,
    }).addTo(map);
    
    // Custom marker icons
    const greenIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
    
    const goldIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
    
    // Add polylines (for trails/paths)
    if (polylines && polylines.length > 0) {
      polylines.forEach(polyline => {
        const line = L.polyline(polyline.coordinates, {
          color: polyline.color || '#5a8a6b',
          weight: polyline.weight || 3,
          opacity: polyline.opacity || 0.7,
          dashArray: polyline.dashArray || null
        }).addTo(map);
        
        if (polyline.popup) {
          line.bindPopup(polyline.popup);
        }
      });
    }
    
    // Add circles (for areas of interest)
    if (circles && circles.length > 0) {
      circles.forEach(circle => {
        const c = L.circle(circle.center, {
          radius: circle.radius || 1000,
          color: circle.color || '#5a8a6b',
          fillColor: circle.fillColor || '#5a8a6b',
          fillOpacity: circle.fillOpacity || 0.2
        }).addTo(map);
        
        if (circle.popup) {
          c.bindPopup(circle.popup);
        }
      });
    }
    
    // Add polygons (for regions)
    if (polygons && polygons.length > 0) {
      polygons.forEach(polygon => {
        const p = L.polygon(polygon.coordinates, {
          color: polygon.color || '#5a8a6b',
          fillColor: polygon.fillColor || '#5a8a6b',
          fillOpacity: polygon.fillOpacity || 0.2
        }).addTo(map);
        
        if (polygon.popup) {
          p.bindPopup(polygon.popup);
        }
      });
    }
    
    // Add markers
    if (markers && markers.length > 0) {
      markers.forEach(marker => {
        const icon = marker.type === 'start' ? greenIcon : goldIcon;
        const m = L.marker(marker.coordinates, { icon }).addTo(map);
        
        let popupContent = `<b>${marker.name}</b>`;
        if (marker.description) {
          popupContent += `<br>${marker.description}`;
        }
        if (showDirections) {
          const lat = marker.coordinates[0];
          const lng = marker.coordinates[1];
          popupContent += `<br><a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" rel="noopener noreferrer" class="text-trail-green hover:underline">üìç Indicazioni stradali</a>`;
        }
        
        m.bindPopup(popupContent);
      });
    }
    
    // Load GPX track if provided
    if (gpxUrl) {
      // GPX loading would require a plugin like leaflet-gpx
      // Future implementation
    }
  };
  
  document.head.appendChild(script);
</script>